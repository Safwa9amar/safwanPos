// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String
  role      UserRole @default(CASHIER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  emailVerified           DateTime?
  emailVerificationToken  String?   @unique

  passwordResetToken          String?   @unique
  passwordResetTokenExpires   DateTime?

  subscriptionStatus      SubscriptionStatus @default(TRIAL)
  trialEndsAt             DateTime?

  createdById String?
  createdBy   User?     @relation("AdminStaff", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  staff       User[]    @relation("AdminStaff")

  sales           Sale[]
  products        Product[]
  categories      Category[]
  customers       Customer[]
  payments        Payment[]
  suppliers       Supplier[]
  purchaseOrders  PurchaseOrder[]
  reports         Report[]
  barcodes        Barcode[]
  expenses        Expense[]
  expenseCategories ExpenseCategory[]
  directPurchases DirectPurchase[]
  capitalEntries  CapitalEntry[]
  supplierPayments SupplierPayment[]
  supplierCredits  SupplierCredit[]
  repairJobs      RepairJob[]
  purchasePriceHistory PurchasePriceHistory[]

  @@index([createdById])
}

enum UserRole {
  ADMIN
  CASHIER
  PHONE_REPAIR
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  INACTIVE
  CANCELED
}

model Product {
  id        String   @id @default(cuid())
  name      String
  price     Float
  stock     Float    @default(0)
  unit      ProductUnit @default(EACH)
  image     String?  @db.VarChar(1024)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  productionDate DateTime?
  expiryDate     DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  barcodes     Barcode[]
  saleItems    SaleItem[]
  purchaseOrderItems PurchaseOrderItem[]
  directPurchaseItems DirectPurchaseItem[]
  
  priceHistory PurchasePriceHistory[] @relation("ProductPriceHistory")

  @@index([userId])
  @@index([categoryId])
}

model PurchasePriceHistory {
  id            String   @id @default(cuid())
  productId     String
  product       Product  @relation("ProductPriceHistory", fields: [productId], references: [id], onDelete: Cascade)
  price         Float
  purchaseDate  DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  directPurchaseItemId String? @unique
  directPurchaseItem   DirectPurchaseItem? @relation(fields: [directPurchaseItemId], references: [id])

  purchaseOrderItemId String? @unique
  purchaseOrderItem   PurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id])
  
  @@index([productId])
  @@index([userId])
}

enum ProductUnit {
  EACH
  KG
  G
  L
  ML
}

model Barcode {
  id        String   @id @default(cuid())
  code      String
  createdAt DateTime @default(now())

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([code, userId])
  @@index([productId])
  @@index([userId])
}


model Category {
  id        String    @id @default(cuid())
  name      String
  products  Product[]

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?  @unique
  address   String?
  balance   Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sales     Sale[]
  payments  Payment[]

  @@index([userId])
}

model Payment {
    id          String @id @default(cuid())
    customerId  String
    customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
    amount      Float
    paymentDate DateTime @default(now())
    notes       String? @db.Text
    
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([customerId])
    @@index([userId])
}


model Sale {
  id          String      @id @default(cuid())
  totalAmount Float
  saleDate    DateTime    @default(now())
  paymentType PaymentType
  amountPaid  Float

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items    SaleItem[]
  
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([customerId])
}

model SaleItem {
  id        String   @id @default(cuid())
  quantity  Float
  price     Float
  
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([saleId])
  @@index([productId])
}

enum PaymentType {
  CASH
  CARD
  CREDIT
}

model Supplier {
  id                 String    @id @default(cuid())
  name               String
  contactName        String?
  email              String?
  phone              String
  address            String?   @db.Text
  balance            Float     @default(0)
  taxId              String?
  category           String?
  paymentTerms       String?
  deliverySchedule   String?
  communicationChannel String?
  status             SupplierStatus @default(ACTIVE)
  logoUrl            String?   @db.VarChar(1024)
  notes              String?   @db.Text
  contractStartDate  DateTime?
  contractEndDate    DateTime?
  monthlySupplyQuota Float?
  qualityRating      Int?

  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  payments       SupplierPayment[]
  credits        SupplierCredit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
}

model PurchaseOrder {
  id          String   @id @default(cuid())
  orderDate   DateTime @default(now())
  expectedDeliveryDate DateTime?
  status      POStatus
  totalCost   Float

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  
  items      PurchaseOrderItem[]

  @@index([userId])
  @@index([supplierId])
}

model PurchaseOrderItem {
  id          String   @id @default(cuid())
  quantity    Int
  costPrice   Float
  receivedQuantity Int @default(0)
  
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  priceHistory PurchasePriceHistory[]

  @@index([purchaseOrderId])
  @@index([productId])
}

enum POStatus {
  PENDING
  PARTIALLY_RECEIVED
  COMPLETED
  CANCELLED
}

model DirectPurchase {
  id             String @id @default(cuid())
  purchaseDate   DateTime @default(now())
  storeName      String?
  notes          String? @db.Text
  totalCost      Float
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items DirectPurchaseItem[]

  @@index([userId])
}

model DirectPurchaseItem {
  id             String @id @default(cuid())
  quantity       Float
  costPrice      Float

  directPurchaseId String
  directPurchase   DirectPurchase @relation(fields: [directPurchaseId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  priceHistory PurchasePriceHistory[]
  
  @@index([directPurchaseId])
  @@index([productId])
}


model SupplierPayment {
    id          String @id @default(cuid())
    supplierId  String
    supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
    amount      Float
    paymentDate DateTime @default(now())
    notes       String? @db.Text
    
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([supplierId])
    @@index([userId])
}

model SupplierCredit {
    id              String @id @default(cuid())
    supplierId      String
    supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
    amount          Float
    reason          String @db.Text
    adjustmentDate  DateTime @default(now())
    
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([supplierId])
    @@index([userId])
}

model Report {
    id        String @id @default(cuid())
    title     String
    content   String @db.LongText
    createdAt DateTime @default(now())

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model ExpenseCategory {
    id        String    @id @default(cuid())
    name      String
    expenses  Expense[]

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([name, userId])
    @@index([userId])
}

model Expense {
    id            String    @id @default(cuid())
    description   String
    amount        Float
    expenseDate   DateTime
    
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    categoryId String
    category   ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

    createdAt     DateTime @default(now())

    @@index([userId])
    @@index([categoryId])
}

model CapitalEntry {
  id        String   @id @default(cuid())
  details   String
  amount    Float
  entryDate DateTime @default(now())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model RepairJob {
  id             String   @id @default(cuid())
  customerName   String
  customerPhone  String
  deviceModel    String
  imei           String?
  reportedProblem String  @db.Text
  notes          String?  @db.Text
  status         String
  estimatedCost  Float?
  finalCost      Float?
  boxNumber      Int?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}
