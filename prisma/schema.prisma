
datasource db {
  provider     = "sqlite"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String    @id @default(cuid())
  name                      String?
  email                     String    @unique
  password                  String
  emailVerified             DateTime?
  emailVerificationToken    String?   @unique
  passwordResetToken        String?   @unique
  passwordResetTokenExpires DateTime?
  role                      String    @default("CASHIER") // ADMIN, CASHIER
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  // For multi-tenancy: users created by an admin
  createdById String?
  createdBy   User?   @relation("UserCreations", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdUsers User[]  @relation("UserCreations")

  // Relations to other models
  products       Product[]
  categories     Category[]
  sales          Sale[]
  customers      Customer[]
  payments       Payment[]
  expenses       Expense[]
  expenseCats    ExpenseCategory[]
  reports        Report[]
  suppliers      Supplier[]
  purchaseOrders PurchaseOrder[]
  repairJobs     RepairJob[]
  barcodes       Barcode[]
  supplierPayments SupplierPayment[]
  supplierCredits  SupplierCredit[]
  directPurchases  DirectPurchase[]
  capitalEntries CapitalEntry[]

  // Subscription fields
  subscriptionStatus      String   @default("TRIAL") // TRIAL, ACTIVE, INACTIVE, CANCELED
  trialEndsAt             DateTime?
}

model Product {
  id          String   @id @default(cuid())
  name        String
  price       Float
  costPrice   Float    @default(0)
  stock       Float
  unit        String   @default("EACH") // EACH, KG, G, L, ML
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onUpdate: NoAction, onDelete: SetNull)

  barcodes          Barcode[]
  saleItems         SaleItem[]
  purchaseOrderItems PurchaseOrderItem[]
  directPurchaseItems DirectPurchaseItem[]

  @@index([userId])
  @@index([categoryId])
}

model Barcode {
  id        String   @id @default(cuid())
  code      String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([code, userId])
  @@index([productId])
  @@index([userId])
}

model Category {
  id        String    @id @default(cuid())
  name      String
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([name, userId])
  @@index([userId])
}

model Sale {
  id          String   @id @default(cuid())
  saleDate    DateTime @default(now())
  totalAmount Float
  amountPaid  Float    @default(0)
  paymentType String   // CASH, CARD, CREDIT
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       SaleItem[]
  customerId  String?
  customer    Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([customerId])
}

model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantity  Float
  price     Float // Price at the time of sale
  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([productId])
}

model Customer {
    id        String   @id @default(cuid())
    name      String
    phone     String?
    email     String?
    address   String?
    balance   Float    @default(0) // Positive for debt, negative for credit
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    sales     Sale[]
    payments  Payment[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@index([userId])
}

model Payment {
    id          String   @id @default(cuid())
    paymentDate DateTime @default(now())
    amount      Float
    notes       String?
    userId      String
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    customerId  String
    customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([customerId])
}

model ExpenseCategory {
    id        String    @id @default(cuid())
    name      String
    userId    String
    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    expenses  Expense[]
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    
    @@unique([name, userId])
    @@index([userId])
}

model Expense {
    id           String          @id @default(cuid())
    description  String
    amount       Float
    expenseDate  DateTime
    userId       String
    user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    categoryId   String
    category     ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
    createdAt    DateTime        @default(now())
    updatedAt    DateTime        @updatedAt

    @@index([userId])
    @@index([categoryId])
}

model Report {
    id          String @id @default(cuid())
    title       String
    content     String
    createdAt   DateTime @default(now())
    userId      String
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@index([userId])
}

model Supplier {
  id                   String          @id @default(cuid())
  name                 String
  contactName          String?
  email                String?
  phone                String
  address              String?
  taxId                String?
  category             String?
  paymentTerms         String?
  deliverySchedule     String?
  communicationChannel String?
  status               String          @default("ACTIVE") // ACTIVE, INACTIVE
  logoUrl              String?
  contractStartDate    DateTime?
  contractEndDate      DateTime?
  monthlySupplyQuota   Float?
  qualityRating        Int?
  notes                String?
  balance              Float           @default(0)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  userId               String
  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchaseOrders       PurchaseOrder[]
  payments             SupplierPayment[]
  credits              SupplierCredit[]

  @@index([userId])
}

model SupplierPayment {
    id          String   @id @default(cuid())
    paymentDate DateTime @default(now())
    amount      Float
    notes       String?
    userId      String
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    supplierId  String
    supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([supplierId])
}

model SupplierCredit {
    id              String   @id @default(cuid())
    adjustmentDate  DateTime @default(now())
    amount          Float
    reason          String
    userId          String
    user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    supplierId      String
    supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([supplierId])
}

model PurchaseOrder {
  id                   String              @id @default(cuid())
  orderDate            DateTime            @default(now())
  expectedDeliveryDate DateTime?
  totalCost            Float
  status               String              @default("PENDING") // PENDING, PARTIALLY_RECEIVED, COMPLETED, CANCELLED
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  userId               String
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplierId           String
  supplier             Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  items                PurchaseOrderItem[]

  @@index([userId])
  @@index([supplierId])
}

model PurchaseOrderItem {
  id                 String        @id @default(cuid())
  quantity           Int
  receivedQuantity   Int           @default(0)
  costPrice          Float
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  purchaseOrderId    String
  purchaseOrder      PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId          String
  product            Product       @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([purchaseOrderId])
  @@index([productId])
}

model RepairJob {
    id              String @id @default(cuid())
    customerName    String
    customerPhone   String
    deviceModel     String
    imei            String?
    reportedProblem String
    notes           String?
    status          String @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, COLLECTED
    estimatedCost   Float?
    finalCost       Float?
    boxNumber       Int?
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
    userId          String
    user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model CapitalEntry {
  id          String   @id @default(cuid())
  entryDate   DateTime @default(now())
  details     String
  amount      Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// New models for direct purchases without a supplier
model DirectPurchase {
  id              String                @id @default(cuid())
  purchaseDate    DateTime              @default(now())
  storeName       String?
  totalCost       Float
  notes           String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  userId          String
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  items           DirectPurchaseItem[]

  @@index([userId])
}

model DirectPurchaseItem {
  id                String          @id @default(cuid())
  quantity          Float
  costPrice         Float
  directPurchaseId  String
  directPurchase    DirectPurchase  @relation(fields: [directPurchaseId], references: [id], onDelete: Cascade)
  productId         String
  product           Product         @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([directPurchaseId])
  @@index([productId])
}
