
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String          @id @default(cuid())
  name            String?
  email           String?         @unique
  role            UserRole        @default(CASHIER)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  products        Product[]
  sales           Sale[]
  purchaseOrders  PurchaseOrder[]
  suppliers       Supplier[]
  categories      Category[]
  customers       Customer[]
  payments        Payment[]
  expenses        Expense[]
  expenseCats     ExpenseCategory[]
  repairJobs      RepairJob[]
}

enum UserRole {
  ADMIN
  CASHIER
}

model Product {
  id          String   @id @default(cuid())
  name        String
  barcode     String
  price       Float
  costPrice   Float    @default(0)
  stock       Float
  unit        String   @default("EACH") // EACH, KG, G, L, ML
  image       String?  @db.VarChar(1024)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  category    Category? @relation(fields: [categoryId], references: [id])
  categoryId  String?

  saleItems         SaleItem[]
  purchaseOrderItems PurchaseOrderItem[]

  @@unique([barcode, userId])
  @@index([userId])
  @@index([categoryId])
}

model Category {
  id        String    @id @default(cuid())
  name      String
  products  Product[]
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
}

model Sale {
  id          String      @id @default(cuid())
  saleDate    DateTime    @default(now())
  totalAmount Float
  paymentType PaymentType
  amountPaid  Float
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       SaleItem[]

  customer    Customer? @relation(fields: [customerId], references: [id])
  customerId  String?

  @@index([userId])
  @@index([customerId])
}

model SaleItem {
  id        String   @id @default(cuid())
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleId    String
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  quantity  Float
  price     Float // Price at the time of sale

  @@index([saleId])
  @@index([productId])
}

model Supplier {
    id String @id @default(cuid())
    name String
    contactName String?
    email String?
    phone String?
    address String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    userId String
    user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    purchaseOrders PurchaseOrder[]

    @@unique([name, userId])
    @@index([userId])
}

model PurchaseOrder {
    id String @id @default(cuid())
    orderDate DateTime @default(now())
    expectedDeliveryDate DateTime?
    status String // e.g., PENDING, COMPLETED, CANCELLED
    totalCost Float
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    supplier            Supplier @relation(fields: [supplierId], references: [id])
    supplierId          String

    items PurchaseOrderItem[]

    @@index([userId])
    @@index([supplierId])
}

model PurchaseOrderItem {
    id String @id @default(cuid())
    purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
    purchaseOrderId String

    product         Product       @relation(fields: [productId], references: [id])
    productId       String

    quantity Int
    costPrice Float // Cost at the time of purchase

    @@index([purchaseOrderId])
    @@index([productId])
}

enum PaymentType {
  CASH
  CARD
  CREDIT
}

model Customer {
    id String @id @default(cuid())
    name String
    phone String?
    email String?
    address String?
    balance Float @default(0)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    sales Sale[]
    payments Payment[]

    @@unique([name, userId])
    @@index([userId])
}

model Payment {
    id String @id @default(cuid())
    paymentDate DateTime @default(now())
    amount Float
    notes String? @db.Text

    userId      String
    user        User     @relation(fields: [userId], references: [id])

    customer    Customer @relation(fields: [customerId], references: [id])
    customerId  String

    @@index([userId])
    @@index([customerId])
}

model ExpenseCategory {
    id        String    @id @default(cuid())
    name      String
    userId    String
    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    expenses  Expense[]

    @@unique([name, userId])
    @@index([userId])
}

model Expense {
    id String @id @default(cuid())
    description String
    amount Float
    expenseDate DateTime @default(now())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    userId          String
    user            User            @relation(fields: [userId], references: [id])
    
    category        ExpenseCategory @relation(fields: [categoryId], references: [id])
    categoryId      String

    @@index([userId])
    @@index([categoryId])
}

model RepairJob {
  id        String   @id @default(cuid())
  customerName String
  customerPhone String
  deviceModel String
  imei      String?
  reportedProblem String @db.Text
  notes     String?  @db.Text
  status    String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, COLLECTED
  estimatedCost Float?
  finalCost Float?
  boxNumber Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
