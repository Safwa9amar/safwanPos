
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id          String @id @default(cuid())
  name        String?
  email       String @unique
  role        UserRole @default(CASHIER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  products    Product[]
  sales       Sale[]
  customers   Customer[]
  payments    Payment[]
  suppliers   Supplier[]
  purchaseOrders PurchaseOrder[]
  repairJobs  RepairJob[]
  categories  Category[]
  expenseCategories ExpenseCategory[]
  expenses    Expense[]
}

enum UserRole {
  ADMIN
  CASHIER
}

model Product {
  id        String    @id @default(cuid())
  name      String
  barcode   String
  price     Float
  costPrice Float
  stock     Float
  unit      String    @default("EACH") // EACH, KG, G, L, ML
  image     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  
  category  Category? @relation(fields: [categoryId], references: [id])
  categoryId String?
  
  saleItems SaleItem[]
  purchaseOrderItems PurchaseOrderItem[]

  @@unique([barcode, userId])
  @@index([userId])
  @@index([categoryId])
}

model Category {
  id        String    @id @default(cuid())
  name      String
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  products  Product[]

  @@unique([name, userId])
  @@index([userId])
}

model Sale {
  id          String      @id @default(cuid())
  saleDate    DateTime    @default(now())
  totalAmount Float
  paymentType PaymentType
  amountPaid  Float

  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  items       SaleItem[]
  
  customer    Customer?   @relation(fields: [customerId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  customerId  String?

  @@index([userId])
  @@index([customerId])
}

enum PaymentType {
  CASH
  CARD
  CREDIT
}

model SaleItem {
  id        String   @id @default(cuid())
  quantity  Float
  price     Float

  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleId    String
  
  product   Product  @relation(fields: [productId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  productId String

  @@index([saleId])
  @@index([productId])
}

model Customer {
  id        String    @id @default(cuid())
  name      String
  phone     String?
  email     String?   @unique
  address   String?
  balance   Float     @default(0)

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  sales     Sale[]
  payments  Payment[]

  @@index([userId])
}

model Payment {
  id          String   @id @default(cuid())
  paymentDate DateTime @default(now())
  amount      Float
  notes       String?

  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId  String

  @@index([userId])
  @@index([customerId])
}

model Supplier {
    id          String   @id @default(cuid())
    name        String
    contactName String?
    email       String?  @unique
    phone       String?
    address     String?

    user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId    String
    
    purchaseOrders PurchaseOrder[]

    @@index([userId])
}

model PurchaseOrder {
    id                  String    @id @default(cuid())
    orderDate           DateTime  @default(now())
    expectedDeliveryDate DateTime?
    status              String    // PENDING, COMPLETED, CANCELLED
    totalCost           Float

    user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId    String
    
    supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
    supplierId  String
    
    items       PurchaseOrderItem[]

    @@index([userId])
    @@index([supplierId])
}

model PurchaseOrderItem {
    id              String   @id @default(cuid())
    quantity        Int
    costPrice       Float

    purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
    purchaseOrderId String
    
    product         Product       @relation(fields: [productId], references: [id], onUpdate: NoAction, onDelete: NoAction)
    productId       String

    @@index([purchaseOrderId])
    @@index([productId])
}

model RepairJob {
  id             String    @id @default(cuid())
  customerName   String
  customerPhone  String
  deviceModel    String
  imei           String?
  reportedProblem String
  notes          String?
  status         String    // PENDING, IN_PROGRESS, COMPLETED, COLLECTED
  estimatedCost  Float?
  finalCost      Float?
  boxNumber      Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  
  @@index([userId])
}

model ExpenseCategory {
  id        String    @id @default(cuid())
  name      String
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  expenses  Expense[]

  @@unique([name, userId])
  @@index([userId])
}

model Expense {
  id            String          @id @default(cuid())
  description   String
  amount        Float
  expenseDate   DateTime
  
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  categoryId    String

  @@index([userId])
  @@index([categoryId])
}

    